version: '3'

tasks:
  bump:
    desc: "Create a release locally (auto version bump)"
    aliases: ["create", "new"]
    summary: |
      Performs a local release with automatic version detection:
      - Analyzes conventional commits
      - Bumps version (major/minor/patch based on commits)
      - Updates CHANGELOG.md
      - Creates git tag
      - Does NOT push (use release:push to push)
    cmds:
      - echo "üîç Analyzing commits for version bump..."
      - uv run cz bump --yes --changelog
      - task: show-version
    preconditions:
      - sh: git diff --quiet
        msg: "Working directory must be clean. Commit or stash changes first."
      - sh: "[ $(git rev-parse --abbrev-ref HEAD) = 'main' ]"
        msg: "Must be on main branch to create releases"

  major:
    desc: "Create a major release (e.g., 0.1.0 ‚Üí 1.0.0)"
    cmds:
      - echo "üöÄ Creating MAJOR release..."
      - uv run cz bump --yes --changelog --increment MAJOR
      - task: show-version
    preconditions:
      - sh: git diff --quiet
        msg: "Working directory must be clean"
      - sh: "[ $(git rev-parse --abbrev-ref HEAD) = 'main' ]"
        msg: "Must be on main branch"

  minor:
    desc: "Create a minor release (e.g., 0.1.0 ‚Üí 0.2.0)"
    cmds:
      - echo "üì¶ Creating MINOR release..."
      - uv run cz bump --yes --changelog --increment MINOR
      - task: show-version
    preconditions:
      - sh: git diff --quiet
        msg: "Working directory must be clean"
      - sh: "[ $(git rev-parse --abbrev-ref HEAD) = 'main' ]"
        msg: "Must be on main branch"

  patch:
    desc: "Create a patch release (e.g., 0.1.0 ‚Üí 0.1.1)"
    cmds:
      - echo "üîß Creating PATCH release..."
      - uv run cz bump --yes --changelog --increment PATCH
      - task: show-version
    preconditions:
      - sh: git diff --quiet
        msg: "Working directory must be clean"
      - sh: "[ $(git rev-parse --abbrev-ref HEAD) = 'main' ]"
        msg: "Must be on main branch"

  dry-run:
    desc: "Preview what version would be released (no changes)"
    aliases: ["preview", "simulate"]
    summary: |
      Shows what the next version would be without making any changes.
      Useful to verify conventional commits are correct.
    cmds:
      - echo "üîç Checking what version would be released..."
      - uv run cz bump --dry-run

  check:
    desc: "Check if a release is needed"
    summary: |
      Determines if there are any feat/fix commits since last release.
      Exit code 0 = release needed, 1 = no release needed.
    cmds:
      - |
        if uv run cz bump --dry-run 2>&1 | grep -q "No new commits found"; then
          echo "‚úÖ No release needed (no feat/fix commits)"
          exit 1
        else
          echo "üì¶ Release needed!"
          exit 0
        fi

  push:
    desc: "Push the release to remote (commits + tags)"
    aliases: ["publish", "deploy"]
    summary: |
      Pushes the local release to remote repository.
      WARNING: This triggers the automated release workflow!
    prompt: "Push release to remote? This will trigger automated release workflow."
    cmds:
      - echo "‚¨ÜÔ∏è  Pushing release to remote..."
      - git push origin main
      - git push origin --tags
      - echo "‚úÖ Pushed! GitHub Actions will create the release."
      - echo "üìç Monitor at: https://github.com/{{.REPO}}/actions"
    vars:
      REPO:
        sh: gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null || echo "P4uLT/py-netatmo-truetemp"

  show-version:
    desc: "Show the current version and next steps"
    internal: true
    cmds:
      - |
        VERSION=$(grep -m1 'version = ' pyproject.toml | cut -d'"' -f2)
        echo ""
        echo "‚úÖ Current version: $VERSION"
        echo "üìù Tag: v$VERSION"
        echo ""
        echo "Next steps:"
        echo "  - Review changes: task git:log"
        echo "  - Check changelog: task changelog:show"
        echo "  - Push to remote: task release:push"
        echo ""
        echo "‚ö†Ô∏è  Note: If you made a mistake, fix forward with a new release."
    silent: true
